<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Argentina: Distribución de población por edad</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    .wrap { max-width: 980px; }
    #controls { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin: 12px 0 6px; }
    #yearValue { font-weight: 700; min-width: 52px; text-align:center; }
    svg { width: 100%; height: auto; }
    .axis path, .axis line { stroke: #bbb; }
    .axis text { fill: #111; font-size: 12px; }
    .title { font-size: 18px; font-weight: 700; margin: 0 0 6px; }
    .subtitle { margin: 0 0 12px; color: #444; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 id="chartTitle" class="title">Distribución de la población por grupo de edad: 2022</h2>

    <div id="controls">
      <label for="yearSlider">Año</label>
      <input id="yearSlider" type="range" min="2022" max="2040" step="1" value="2022" />
      <span id="yearValue">2022</span>
    </div>

    <svg id="chart" viewBox="0 0 980 520" role="img" aria-label="Distribución de población por grupo de edad"></svg>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    const CSV_PATH = "https://raw.githubusercontent.com/francossian/dataviz-d3/refs/heads/main/2026-01-19_demografia-edad-argentina/datos-poblacion.csv"; // <-- ajustá si está en otra carpeta

    const svg = d3.select("#chart");
    const W = 980, H = 520;

    const margin = { top: 30, right: 24, bottom: 140, left: 80 };
    const width  = W - margin.left - margin.right;
    const height = H - margin.top - margin.bottom;

    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleBand().range([0, width]).padding(0.18);
    const y = d3.scaleLinear().range([height, 0]);

    const xAxisG = g.append("g").attr("class", "axis").attr("transform", `translate(0,${height})`);
    const yAxisG = g.append("g").attr("class", "axis");

    // Labels ejes
    g.append("text")
      .attr("x", width / 2)
      .attr("y", height + 110)
      .attr("text-anchor", "middle")
      .style("font-weight", 600)
      .text("Grupo de edad");

    g.append("text")
      .attr("transform", "rotate(-90)")
      .attr("x", -height / 2)
      .attr("y", -58)
      .attr("text-anchor", "middle")
      .style("font-weight", 600)
      .text("Población (%)");

    const titleEl = document.getElementById("chartTitle");
    const sliderEl = document.getElementById("yearSlider");
    const yearValueEl = document.getElementById("yearValue");

    let rawRows = [];
    let YEARS = [];

    // Parser robusto por si viene con coma decimal
    function parseNumber(v) {
      if (v == null) return NaN;
      const s = String(v).trim().replace("%", "").replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function update(year) {
      year = String(year);

      // Title + UI
      titleEl.textContent = `Distribución de la población por grupo de edad: ${year}`;
      yearValueEl.textContent = year;

      // Build series
      const data = rawRows.map(r => ({
        GrupoEdad: r.GrupoEdad,
        value: r[year]
      }));

      // Domains
      x.domain(data.map(d => d.GrupoEdad));

      // y max (valores tipo 0.1 => 10%)
      const yMax = d3.max(data, d => d.value);
      y.domain([0, (yMax ?? 0) * 1.12]);

      // Axes
      xAxisG
        .call(d3.axisBottom(x))
        .selectAll("text")
          .attr("text-anchor", "end")
          .attr("transform", "rotate(-35)")
          .attr("dx", "-0.6em")
          .attr("dy", "0.6em");

      yAxisG.call(
        d3.axisLeft(y)
          .ticks(6)
          .tickFormat(d3.format(".0%")) // 0.1 -> 10%
      );

      // Bars
      const bars = g.selectAll("rect.bar")
        .data(data, d => d.GrupoEdad);

      bars.enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.GrupoEdad))
        .attr("width", x.bandwidth())
        .attr("y", height)
        .attr("height", 0)
        .merge(bars)
        .transition()
          .duration(500)
          .attr("x", d => x(d.GrupoEdad))
          .attr("width", x.bandwidth())
          .attr("y", d => y(d.value))
          .attr("height", d => height - y(d.value));

      bars.exit().remove();
    }

    d3.csv(CSV_PATH, (row) => {
      const out = { GrupoEdad: row.GrupoEdad };

      // Copiamos todas las columnas año (excepto GrupoEdad) como numbers
      for (const [k, v] of Object.entries(row)) {
        if (k === "GrupoEdad") continue;
        out[k] = parseNumber(v);
      }
      return out;
    }).then(rows => {
      rawRows = rows;

      // Inferir años desde columnas (excepto GrupoEdad)
      const cols = Object.keys(rows[0] || {});
      YEARS = cols
        .filter(c => c !== "GrupoEdad")
        .map(c => Number(c))
        .filter(y => Number.isFinite(y))
        .sort((a,b) => a - b);

      // Configurar slider según años disponibles
      const minY = d3.min(YEARS), maxY = d3.max(YEARS);
      sliderEl.min = minY;
      sliderEl.max = maxY;
      sliderEl.step = 1;

      // Año inicial
      const initialYear = (YEARS.includes(2022) ? 2022 : minY);
      sliderEl.value = initialYear;
      update(initialYear);

      // Slider event
      sliderEl.addEventListener("input", (e) => {
        const y = Number(e.target.value);

        // Si por alguna razón faltara un año intermedio, “snap” al más cercano existente
        let chosen = y;
        if (!YEARS.includes(y)) {
          chosen = YEARS.reduce((best, cur) =>
            Math.abs(cur - y) < Math.abs(best - y) ? cur : best
          , YEARS[0]);
          sliderEl.value = chosen;
        }

        update(chosen);
      });
    }).catch(err => {
      console.error("Error cargando CSV:", err);
      titleEl.textContent = "No se pudo cargar el CSV. Revisá el path y el servidor local.";
    });
  </script>
</body>
</html>